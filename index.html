<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Drawing Match</title>
        
        <!-- jsPsych -->
        <script src="https://unpkg.com/jspsych@7.3.4"></script>
        <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
        <script src="https://unpkg.com/@jspsych/plugin-image-button-response@1.1.3"></script>
        <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>
        <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.3"></script>
        <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3"></script>
        <script src="https://unpkg.com/@jspsych/plugin-browser-check@1.0.3"></script>

        <!-- jsPsych CSS -->
        <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
        <!-- DataPipe for OSF -->
        <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
        
        <style>
            body {
                background-color: #f5f5f5;
                font-family: Arial, sans-serif;
            }

            #jspsych-content {
                max-width: 1400px; 
                margin: auto;
            }

            #jspsych-image-button-response-btngroup {
                display: flex !important;
                flex-direction: row !important;
                justify-content: center !important;
                align-items: flex-start !important;
                flex-wrap: nowrap !important;
                gap: 10px;
            }

            #jspsych-image-button-response-btngroup .jspsych-btn {
                margin: 0;
                padding: 0;
                border: 3px solid #ddd;
                background-color: white;
                cursor: pointer;
                transition: border-color 0.3s;
                flex-shrink: 0;
                width: 380px; 
                height: 380px;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
            }

            #jspsych-image-button-response-btngroup .jspsych-btn:hover {
                border-color: #2196F3;
            }

            .jspsych-btn {
                padding: 10px 20px;
                border: 1px solid #ccc;
                background-color: white;
                cursor: pointer;
            }

            .jspsych-btn img {
                display: block;
                max-width: 380px !important;
                max-height: 380px !important;
                width: auto !important;
                height: auto !important;
                object-fit: contain;
            }
        </style>
        
        
        <script>
            // config
            let trial_count = 0;
            const SAVE_FREQUENCY = 5;

            const OSF_CONFIG = {
                experiment_id: 'ovx64kYVxBXt',
                filename: null // dynamic by datapipe
                // dataType: 'json'
            };

            const EXPERIMENT_PARAMS = {
                n_trials: 60, // # trials per participant
                n_attention_checks: 3, // # attention check trials
                trial_timeout: 1800000, // 30 minutes (ms)
                min_rt_treshold: 500, // minimum RT for valid trials
                image_size: [380, 380] // for reference, the actual sizes are set directly in trial creation
            }

            const CATEGORIES = [
                'amusement_park',
                'badlands',
                'bathroom',
                'bedroom',
                'dining_room',
                'farm',
                'fountain',
                'garden',
                'house',
                'kitchen',
                'lighthouse',
                'living_room',
                'mountain',
                'playground',
                'pool',
                'street',
                'tower'
            ];

            const COMPLETION_CODE = 'TODO' // TODO
            
            // stimulus
            
            function generateDrawingStimuli() {
                const stimuli = [];

                // AMUSEMENTPARK
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/25_13_high_amusementpark.jpg',
                    condition: 'delayed_recall',
                    category: 'amusementpark',
                    target_image: 'data/stim/amusement_park_high.jpg',
                    memorability: 'high',
                    high_image: 'data/stim/amusement_park_high.jpg',
                    low_image: 'data/stim/amusement_park_low.jpg',
                    foil_image: 'data/stim/amusement_park_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/24_9_low_amusementpark.jpg',
                    condition: 'delayed_recall',
                    category: 'amusementpark',
                    target_image: 'data/stim/amusement_park_low.jpg',
                    memorability: 'low',
                    high_image: 'data/stim/amusement_park_high.jpg',
                    low_image: 'data/stim/amusement_park_low.jpg',
                    foil_image: 'data/stim/amusement_park_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c12_27_amusementpark.jpg',
                    condition: 'category',
                    category: 'amusementpark',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/amusement_park_high.jpg',
                    low_image: 'data/stim/amusement_park_low.jpg',
                    foil_image: 'data/stim/amusement_park_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c8_28_amusementpark.jpg',
                    condition: 'category',
                    category: 'amusementpark',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/amusement_park_high.jpg',
                    low_image: 'data/stim/amusement_park_low.jpg',
                    foil_image: 'data/stim/amusement_park_foil.jpg'
                });

                // BADLANDS
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/15_12_high_badlands.jpg',
                    condition: 'delayed_recall',
                    category: 'badlands',
                    target_image: 'data/stim/badlands_high.jpg',
                    memorability: 'high',
                    high_image: 'data/stim/badlands_high.jpg',
                    low_image: 'data/stim/badlands_low.jpg',
                    foil_image: 'data/stim/badlands_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/7_9_low_badlands.jpg',
                    condition: 'delayed_recall',
                    category: 'badlands',
                    target_image: 'data/stim/badlands_low.jpg',
                    memorability: 'low',
                    high_image: 'data/stim/badlands_high.jpg',
                    low_image: 'data/stim/badlands_low.jpg',
                    foil_image: 'data/stim/badlands_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c1_27_badlands.jpg',
                    condition: 'category',
                    category: 'badlands',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/badlands_high.jpg',
                    low_image: 'data/stim/badlands_low.jpg',
                    foil_image: 'data/stim/badlands_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c11_15_badlands.jpg',
                    condition: 'category',
                    category: 'badlands',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/badlands_high.jpg',
                    low_image: 'data/stim/badlands_low.jpg',
                    foil_image: 'data/stim/badlands_foil.jpg'
                });

                // BATHROOM
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/7_19_high_bathroom.jpg',
                    condition: 'delayed_recall',
                    category: 'bathroom',
                    target_image: 'data/stim/bathroom_high.jpg',
                    memorability: 'high',
                    high_image: 'data/stim/bathroom_high.jpg',
                    low_image: 'data/stim/bathroom_low.jpg',
                    foil_image: 'data/stim/bathroom_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/15_2_low_bathroom.jpg',
                    condition: 'delayed_recall',
                    category: 'bathroom',
                    target_image: 'data/stim/bathroom_low.jpg',
                    memorability: 'low',
                    high_image: 'data/stim/bathroom_high.jpg',
                    low_image: 'data/stim/bathroom_low.jpg',
                    foil_image: 'data/stim/bathroom_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c13_4_bathroom.jpg',
                    condition: 'category',
                    category: 'bathroom',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/bathroom_high.jpg',
                    low_image: 'data/stim/bathroom_low.jpg',
                    foil_image: 'data/stim/bathroom_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c7_10_bathroom.jpg',
                    condition: 'category',
                    category: 'bathroom',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/bathroom_high.jpg',
                    low_image: 'data/stim/bathroom_low.jpg',
                    foil_image: 'data/stim/bathroom_foil.jpg'
                });

                // BEDROOM
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/18_5_high_bedroom.jpg',
                    condition: 'delayed_recall',
                    category: 'bedroom',
                    target_image: 'data/stim/bedroom_high.jpg',
                    memorability: 'high',
                    high_image: 'data/stim/bedroom_high.jpg',
                    low_image: 'data/stim/bedroom_low.jpg',
                    foil_image: 'data/stim/bedroom_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/27_3_low_bedroom.jpg',
                    condition: 'delayed_recall',
                    category: 'bedroom',
                    target_image: 'data/stim/bedroom_low.jpg',
                    memorability: 'low',
                    high_image: 'data/stim/bedroom_high.jpg',
                    low_image: 'data/stim/bedroom_low.jpg',
                    foil_image: 'data/stim/bedroom_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c1_7_bedroom.jpg',
                    condition: 'category',
                    category: 'bedroom',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/bedroom_high.jpg',
                    low_image: 'data/stim/bedroom_low.jpg',
                    foil_image: 'data/stim/bedroom_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c7_3_bedroom.jpg',
                    condition: 'category',
                    category: 'bedroom',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/bedroom_high.jpg',
                    low_image: 'data/stim/bedroom_low.jpg',
                    foil_image: 'data/stim/bedroom_foil.jpg'
                });

                // DININGROOM
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/4_19_high_diningroom.jpg',
                    condition: 'delayed_recall',
                    category: 'diningroom',
                    target_image: 'data/stim/dining_room_high.jpg',
                    memorability: 'high',
                    high_image: 'data/stim/dining_room_high.jpg',
                    low_image: 'data/stim/dining_room_low.jpg',
                    foil_image: 'data/stim/dining_room_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/6_11_low_diningroom.jpg',
                    condition: 'delayed_recall',
                    category: 'diningroom',
                    target_image: 'data/stim/dining_room_low.jpg',
                    memorability: 'low',
                    high_image: 'data/stim/dining_room_high.jpg',
                    low_image: 'data/stim/dining_room_low.jpg',
                    foil_image: 'data/stim/dining_room_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c1_2_diningroom.jpg',
                    condition: 'category',
                    category: 'diningroom',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/dining_room_high.jpg',
                    low_image: 'data/stim/dining_room_low.jpg',
                    foil_image: 'data/stim/dining_room_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c9_19_diningroom.jpg',
                    condition: 'category',
                    category: 'diningroom',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/dining_room_high.jpg',
                    low_image: 'data/stim/dining_room_low.jpg',
                    foil_image: 'data/stim/dining_room_foil.jpg'
                });

                // FARM
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/31_5_high_farm.jpg',
                    condition: 'delayed_recall',
                    category: 'farm',
                    target_image: 'data/stim/farm_high.jpg',
                    memorability: 'high',
                    high_image: 'data/stim/farm_high.jpg',
                    low_image: 'data/stim/farm_low.jpg',
                    foil_image: 'data/stim/farm_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/25_3_low_farm.jpg',
                    condition: 'delayed_recall',
                    category: 'farm',
                    target_image: 'data/stim/farm_low.jpg',
                    memorability: 'low',
                    high_image: 'data/stim/farm_high.jpg',
                    low_image: 'data/stim/farm_low.jpg',
                    foil_image: 'data/stim/farm_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c4_7_farm.jpg',
                    condition: 'category',
                    category: 'farm',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/farm_high.jpg',
                    low_image: 'data/stim/farm_low.jpg',
                    foil_image: 'data/stim/farm_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c1_14_farm.jpg',
                    condition: 'category',
                    category: 'farm',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/farm_high.jpg',
                    low_image: 'data/stim/farm_low.jpg',
                    foil_image: 'data/stim/farm_foil.jpg'
                });

                // FOUNTAIN
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/4_22_high_fountain.jpg',
                    condition: 'delayed_recall',
                    category: 'fountain',
                    target_image: 'data/stim/fountain_high.jpg',
                    memorability: 'high',
                    high_image: 'data/stim/fountain_high.jpg',
                    low_image: 'data/stim/fountain_low.jpg',
                    foil_image: 'data/stim/fountain_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/17_8_low_fountain.jpg',
                    condition: 'delayed_recall',
                    category: 'fountain',
                    target_image: 'data/stim/fountain_low.jpg',
                    memorability: 'low',
                    high_image: 'data/stim/fountain_high.jpg',
                    low_image: 'data/stim/fountain_low.jpg',
                    foil_image: 'data/stim/fountain_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c4_24_fountain.jpg',
                    condition: 'category',
                    category: 'fountain',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/fountain_high.jpg',
                    low_image: 'data/stim/fountain_low.jpg',
                    foil_image: 'data/stim/fountain_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c2_20_fountain.jpg',
                    condition: 'category',
                    category: 'fountain',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/fountain_high.jpg',
                    low_image: 'data/stim/fountain_low.jpg',
                    foil_image: 'data/stim/fountain_foil.jpg'
                });

                // GARDEN
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/31_3_high_garden.jpg',
                    condition: 'delayed_recall',
                    category: 'garden',
                    target_image: 'data/stim/garden_high.jpg',
                    memorability: 'high',
                    high_image: 'data/stim/garden_high.jpg',
                    low_image: 'data/stim/garden_low.jpg',
                    foil_image: 'data/stim/garden_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/26_2_low_garden.jpg',
                    condition: 'delayed_recall',
                    category: 'garden',
                    target_image: 'data/stim/garden_low.jpg',
                    memorability: 'low',
                    high_image: 'data/stim/garden_high.jpg',
                    low_image: 'data/stim/garden_low.jpg',
                    foil_image: 'data/stim/garden_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c4_1_garden.jpg',
                    condition: 'category',
                    category: 'garden',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/garden_high.jpg',
                    low_image: 'data/stim/garden_low.jpg',
                    foil_image: 'data/stim/garden_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c12_28_garden.jpg',
                    condition: 'category',
                    category: 'garden',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/garden_high.jpg',
                    low_image: 'data/stim/garden_low.jpg',
                    foil_image: 'data/stim/garden_foil.jpg'
                });

                // HOUSE
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/12_7_high_house.jpg',
                    condition: 'delayed_recall',
                    category: 'house',
                    target_image: 'data/stim/house_high.jpg',
                    memorability: 'high',
                    high_image: 'data/stim/house_high.jpg',
                    low_image: 'data/stim/house_low.jpg',
                    foil_image: 'data/stim/house_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/7_17_low_house.jpg',
                    condition: 'delayed_recall',
                    category: 'house',
                    target_image: 'data/stim/house_low.jpg',
                    memorability: 'low',
                    high_image: 'data/stim/house_high.jpg',
                    low_image: 'data/stim/house_low.jpg',
                    foil_image: 'data/stim/house_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c10_15_house.jpg',
                    condition: 'category',
                    category: 'house',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/house_high.jpg',
                    low_image: 'data/stim/house_low.jpg',
                    foil_image: 'data/stim/house_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c12_29_house.jpg',
                    condition: 'category',
                    category: 'house',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/house_high.jpg',
                    low_image: 'data/stim/house_low.jpg',
                    foil_image: 'data/stim/house_foil.jpg'
                });

                // KITCHEN
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/11_9_high_kitchen.jpg',
                    condition: 'delayed_recall',
                    category: 'kitchen',
                    target_image: 'data/stim/kitchen_high.jpg',
                    memorability: 'high',
                    high_image: 'data/stim/kitchen_high.jpg',
                    low_image: 'data/stim/kitchen_low.jpg',
                    foil_image: 'data/stim/kitchen_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/21_6_low_kitchen.jpg',
                    condition: 'delayed_recall',
                    category: 'kitchen',
                    target_image: 'data/stim/kitchen_low.jpg',
                    memorability: 'low',
                    high_image: 'data/stim/kitchen_high.jpg',
                    low_image: 'data/stim/kitchen_low.jpg',
                    foil_image: 'data/stim/kitchen_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c4_2_kitchen.jpg',
                    condition: 'category',
                    category: 'kitchen',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/kitchen_high.jpg',
                    low_image: 'data/stim/kitchen_low.jpg',
                    foil_image: 'data/stim/kitchen_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c12_1_kitchen.jpg',
                    condition: 'category',
                    category: 'kitchen',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/kitchen_high.jpg',
                    low_image: 'data/stim/kitchen_low.jpg',
                    foil_image: 'data/stim/kitchen_foil.jpg'
                });

                // LIGHTHOUSE
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/22_1_high_lighthouse.jpg',
                    condition: 'delayed_recall',
                    category: 'lighthouse',
                    target_image: 'data/stim/lighthouse_high.jpg',
                    memorability: 'high',
                    high_image: 'data/stim/lighthouse_high.jpg',
                    low_image: 'data/stim/lighthouse_low.jpg',
                    foil_image: 'data/stim/lighthouse_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/23_11_low_lighthouse.jpg',
                    condition: 'delayed_recall',
                    category: 'lighthouse',
                    target_image: 'data/stim/lighthouse_low.jpg',
                    memorability: 'low',
                    high_image: 'data/stim/lighthouse_high.jpg',
                    low_image: 'data/stim/lighthouse_low.jpg',
                    foil_image: 'data/stim/lighthouse_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c9_11_lighthouse.jpg',
                    condition: 'category',
                    category: 'lighthouse',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/lighthouse_high.jpg',
                    low_image: 'data/stim/lighthouse_low.jpg',
                    foil_image: 'data/stim/lighthouse_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c4_10_lighthouse.jpg',
                    condition: 'category',
                    category: 'lighthouse',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/lighthouse_high.jpg',
                    low_image: 'data/stim/lighthouse_low.jpg',
                    foil_image: 'data/stim/lighthouse_foil.jpg'
                });

                // LIVINGROOM
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/34_10_high_livingroom.jpg',
                    condition: 'delayed_recall',
                    category: 'livingroom',
                    target_image: 'data/stim/living_room_high.jpg',
                    memorability: 'high',
                    high_image: 'data/stim/living_room_high.jpg',
                    low_image: 'data/stim/living_room_low.jpg',
                    foil_image: 'data/stim/living_room_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/11_10_low_livingroom.jpg',
                    condition: 'delayed_recall',
                    category: 'livingroom',
                    target_image: 'data/stim/living_room_low.jpg',
                    memorability: 'low',
                    high_image: 'data/stim/living_room_high.jpg',
                    low_image: 'data/stim/living_room_low.jpg',
                    foil_image: 'data/stim/living_room_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c2_9_livingroom.jpg',
                    condition: 'category',
                    category: 'livingroom',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/living_room_high.jpg',
                    low_image: 'data/stim/living_room_low.jpg',
                    foil_image: 'data/stim/living_room_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c3_7_livingroom.jpg',
                    condition: 'category',
                    category: 'livingroom',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/living_room_high.jpg',
                    low_image: 'data/stim/living_room_low.jpg',
                    foil_image: 'data/stim/living_room_foil.jpg'
                });

                // MOUNTAIN
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/26_14_high_mountain.jpg',
                    condition: 'delayed_recall',
                    category: 'mountain',
                    target_image: 'data/stim/mountain_high.jpg',
                    memorability: 'high',
                    high_image: 'data/stim/mountain_high.jpg',
                    low_image: 'data/stim/mountain_low.jpg',
                    foil_image: 'data/stim/mountain_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/14_7_low_mountain.jpg',
                    condition: 'delayed_recall',
                    category: 'mountain',
                    target_image: 'data/stim/mountain_low.jpg',
                    memorability: 'low',
                    high_image: 'data/stim/mountain_high.jpg',
                    low_image: 'data/stim/mountain_low.jpg',
                    foil_image: 'data/stim/mountain_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c10_22_mountain.jpg',
                    condition: 'category',
                    category: 'mountain',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/mountain_high.jpg',
                    low_image: 'data/stim/mountain_low.jpg',
                    foil_image: 'data/stim/mountain_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c12_4_mountain.jpg',
                    condition: 'category',
                    category: 'mountain',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/mountain_high.jpg',
                    low_image: 'data/stim/mountain_low.jpg',
                    foil_image: 'data/stim/mountain_foil.jpg'
                });

                // PLAYGROUND
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/7_13_high_playground.jpg',
                    condition: 'delayed_recall',
                    category: 'playground',
                    target_image: 'data/stim/playground_high.jpg',
                    memorability: 'high',
                    high_image: 'data/stim/playground_high.jpg',
                    low_image: 'data/stim/playground_low.jpg',
                    foil_image: 'data/stim/playground_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/4_5_low_playground.jpg',
                    condition: 'delayed_recall',
                    category: 'playground',
                    target_image: 'data/stim/playground_low.jpg',
                    memorability: 'low',
                    high_image: 'data/stim/playground_high.jpg',
                    low_image: 'data/stim/playground_low.jpg',
                    foil_image: 'data/stim/playground_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c2_24_playground.jpg',
                    condition: 'category',
                    category: 'playground',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/playground_high.jpg',
                    low_image: 'data/stim/playground_low.jpg',
                    foil_image: 'data/stim/playground_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c10_18_playground.jpg',
                    condition: 'category',
                    category: 'playground',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/playground_high.jpg',
                    low_image: 'data/stim/playground_low.jpg',
                    foil_image: 'data/stim/playground_foil.jpg'
                });

                // POOL
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/22_13_high_pool.jpg',
                    condition: 'delayed_recall',
                    category: 'pool',
                    target_image: 'data/stim/pool_high.jpg',
                    memorability: 'high',
                    high_image: 'data/stim/pool_high.jpg',
                    low_image: 'data/stim/pool_low.jpg',
                    foil_image: 'data/stim/pool_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/7_5_low_pool.jpg',
                    condition: 'delayed_recall',
                    category: 'pool',
                    target_image: 'data/stim/pool_low.jpg',
                    memorability: 'low',
                    high_image: 'data/stim/pool_high.jpg',
                    low_image: 'data/stim/pool_low.jpg',
                    foil_image: 'data/stim/pool_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c7_1_pool.jpg',
                    condition: 'category',
                    category: 'pool',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/pool_high.jpg',
                    low_image: 'data/stim/pool_low.jpg',
                    foil_image: 'data/stim/pool_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c12_19_pool.jpg',
                    condition: 'category',
                    category: 'pool',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/pool_high.jpg',
                    low_image: 'data/stim/pool_low.jpg',
                    foil_image: 'data/stim/pool_foil.jpg'
                });

                // STREET
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/20_10_high_street.jpg',
                    condition: 'delayed_recall',
                    category: 'street',
                    target_image: 'data/stim/street_high.jpg',
                    memorability: 'high',
                    high_image: 'data/stim/street_high.jpg',
                    low_image: 'data/stim/street_low.jpg',
                    foil_image: 'data/stim/street_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/27_10_low_street.jpg',
                    condition: 'delayed_recall',
                    category: 'street',
                    target_image: 'data/stim/street_low.jpg',
                    memorability: 'low',
                    high_image: 'data/stim/street_high.jpg',
                    low_image: 'data/stim/street_low.jpg',
                    foil_image: 'data/stim/street_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c8_27_street.jpg',
                    condition: 'category',
                    category: 'street',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/street_high.jpg',
                    low_image: 'data/stim/street_low.jpg',
                    foil_image: 'data/stim/street_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c10_26_street.jpg',
                    condition: 'category',
                    category: 'street',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/street_high.jpg',
                    low_image: 'data/stim/street_low.jpg',
                    foil_image: 'data/stim/street_foil.jpg'
                });

                // TOWER
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/22_18_high_tower.jpg',
                    condition: 'delayed_recall',
                    category: 'tower',
                    target_image: 'data/stim/tower_high.jpg',
                    memorability: 'high',
                    high_image: 'data/stim/tower_high.jpg',
                    low_image: 'data/stim/tower_low.jpg',
                    foil_image: 'data/stim/tower_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/delayed_recall/28_8_low_tower.jpg',
                    condition: 'delayed_recall',
                    category: 'tower',
                    target_image: 'data/stim/tower_low.jpg',
                    memorability: 'low',
                    high_image: 'data/stim/tower_high.jpg',
                    low_image: 'data/stim/tower_low.jpg',
                    foil_image: 'data/stim/tower_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c14_13_tower.jpg',
                    condition: 'category',
                    category: 'tower',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/tower_high.jpg',
                    low_image: 'data/stim/tower_low.jpg',
                    foil_image: 'data/stim/tower_foil.jpg'
                });
                stimuli.push({
                    drawing: 'data/drawings/category/c12_2_tower.jpg',
                    condition: 'category',
                    category: 'tower',
                    target_image: null,
                    memorability: null,
                    high_image: 'data/stim/tower_high.jpg',
                    low_image: 'data/stim/tower_low.jpg',
                    foil_image: 'data/stim/tower_foil.jpg'
                });

                return stimuli;
            }


            // attention check trials
            const ATTENTION_CHECKS = [
                {
                    type: 'text_instruction',
                    instruction: 'Please select the LEFTMOST image to show you are paying attention.',
                    images: [
                        'data/stim/bedroom_high.jpg',    // left (correct)
                        'data/stim/kitchen_high.jpg',    // center
                        'data/stim/bathroom_high.jpg'    // right
                    ], 
                    correct_position: 0 // 0=left
                },
                {
                    type: 'text_instruction',
                    instruction: 'Please select the CENTER image to show you are paying attention.',
                    images: [
                        'data/stim/farm_high.jpg',       // left
                        'data/stim/garden_high.jpg',     // center (correct)
                        'data/stim/fountain_high.jpg'    // right                    
                    ], 
                    correct_position: 1

                },
                {
                    type: 'text_instruction',
                    instruction: 'Please select the RIGHTMOST image to show you are paying attention.',
                    images: [
                        'data/stim/pool_high.jpg',       // left
                        'data/stim/street_high.jpg',     // center
                        'data/stim/tower_high.jpg'       // right (correct)
                    ], 
                    correct_position: 2

                },
            ];

            function getAllPossibleImages() {
                const all_images = [];

                const all_drawings = generateDrawingStimuli();
                all_drawings.forEach(stimulus => {
                    all_images.push(stimulus.drawing);
                    all_images.push(stimulus.high_image);
                    all_images.push(stimulus.low_image);
                    all_images.push(stimulus.foil_image);
                });

                ATTENTION_CHECKS.forEach(check => {
                    check.images.forEach(image => {
                        all_images.push(image);
                    });
                });

                return[...new Set(all_images)];
            }


            // experiment logic

            let jsPsych;
            let timeline = [];
            let participant_id;
            let start_time;

            window.onload = function() {
                // get prolific ID from URL parameter
                const urlParams = new URLSearchParams(window.location.search);
                participant_id = urlParams.get('PROLIFIC_ID') || 'debug_' + Date.now();

                // datapipe filename with participant ID
                OSF_CONFIG.filename = `${participant_id}.json`;

                jsPsych = initJsPsych({
                    show_progress_bar: true,
                    auto_update_progress_bar: false,
                    message_progress_bar: 'Progress',
                    on_finish: function() {
                        displayCompletionCode();
                    },
                    on_close: function() {
                        // saveData();
                    }
                });

                buildTimeline();
                jsPsych.run(timeline);
            }
            
            // build experiment timeline
            function buildTimeline() {
                // browser check
                const browser_check = {
                    type: jsPsychBrowserCheck,
                    inclusion_function: (data) => {
                        return !data.mobile;
                    },
                    exclusion_message: (data) => {
                        if (data.mobile) {
                            return '<p>This experiment must be completed on a desktop or laptop computer. Mobile devices are not supported.</p><p>Please return to this experiment on a desktop or laptop computer.</p>';
                        }
                    }
                };
                timeline.push(browser_check);

                // preload images
                const preload = {
                    type: jsPsychPreload,
                    images: getAllPossibleImages(),
                    message: '<p>Loading...</p>',
                    error_message: '<p>Some images failed to load. Please check your internet connection and refresh the page.</p>',
                    continue_after_error: false,
                    show_progress_bar: true
                };
                timeline.push(preload);

                // welcome
                const welcome = {
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: `
                        <div style="max-width: 800px; margin: auto; text-align: left;">
                            <h1>Welcome to the Drawing Match!</h1>
                            <p>Thank you for participating in this study.</p>
                            <p>In this experiment, you will see drawings of everyday scenes. Your task is to match each drawing to one of three photographs.</p>
                            <p>The experiment will take 5-10 minutes to complete.</p>
                            <p><strong>Important:</strong></p>
                            <ul style="text-align: left;">
                                <li>Please enter into **fullscreen** mode on your browser</li>
                                <li>Please complete this study in a quiet environment without distractions</li>
                                <li>Do not use the back button in your browser</li>
                                <li>Please stay focused on the task throughout</li>
                            </ul>
                            <p>Press the <strong>SPACE BAR</strong> to continue.</p>
                        </div>
                    `,
                    choices: [' ']
                };
                timeline.push(welcome);

                // instructions
                const instructions = {
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: `
                        <div style="max-width: 800px; margin: auto; text-align: left;">
                            <h2>Instructions</h2>
                            <p>On each trial, you will see:</p>
                            <ul style="text-align: left;">
                                <li>One drawing at the top of the screen</li>
                                <li>Three photographs below the drawing</li>
                            </ul>
                            <p><strong>Your task:</strong> Click on the photograph that you think the drawing best represents.</p>
                            <p>The three photographs will always be from the same scene category (e.g., three different kitchens).</p>
                            <p>Even if the drawing is rough or incomplete, please try your best to make a match.</p>
                            <p>There is no time limit for each trial, but please respond as accurately as you can.</p>
                            <p>You will complete approximately 60 trials.</p>
                            <p>Press the <strong>SPACE BAR</strong> when you're ready to begin.</p>
                        </div>
                    `,
                    choices: [' '],
                    on_finish: function() {
                        start_time = Date.now();
                    }
                };
                timeline.push(instructions);

                // generate trials
                const trials = generateTrials();
                timeline.push(...trials);

                // ending survey
                const technical_difficulties = {
                    type: jsPsychSurveyMultiChoice,
                    questions: [
                        {
                            prompt: "Did you experience any technical difficulties during the task?",
                            name: 'technical_difficulties',
                            options: ['Yes', 'No'],
                            required: true
                        }
                    ]
                };
                timeline.push(technical_difficulties);

                const technical_explanation = {
                    type: jsPsychSurveyText,
                    questions: [
                        {
                            prompt: "If you experienced technical difficulties, please describe them briefly:",
                            name: 'technical_explanation',
                            rows: 3,
                            required: false
                        }
                    ]
                };
                timeline.push(technical_explanation);

                const comments = {
                    type: jsPsychSurveyText,
                    questions: [
                        {
                            prompt: "Do you have any comments about the study?",
                            name: 'comments',
                            rows: 3,
                            required: false
                        }
                    ],
                    on_finish: function() {
                        // saveData();
                    }
                };
                timeline.push(comments);

                // final save
                const final_save = {
                    type: jsPsychPipe,
                    action: "save",
                    experiment_id: OSF_CONFIG.experiment_id,
                    filename: OSF_CONFIG.filename,
                    data_string: () => jsPsych.data.get().json()
                };
                timeline.push(final_save);

                // debrief
                const debrief = {
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: function() {
                        return `
                            <div style="max-width: 800px; margin: auto; text-align: left;">
                                <h2>Thank you for participating!</h2>
                                <p>You have completed the study.</p>
                                <p><strong>Your Prolific completion code is:</strong></p>
                                <h1 style="color: #2196F3; font-family: monospace;">${COMPLETION_CODE}</h1>
                                <p>Please copy this code and return to Prolific to paste it there.</p>
                                <p>Press any key to finish.</p>
                            </div>
                        `;
                    },
                    choices: "ALL_KEYS"
                };
                timeline.push(debrief);
            }
            
            // generate experimental trials
            function generateTrials() {
                const all_trials = [];

                // get all drawings
                const all_drawings = generateDrawingStimuli();

                // randomly sample 60 drawings without replacement
                const sampled_drawings = jsPsych.randomization.sampleWithoutReplacement(
                    all_drawings,
                    EXPERIMENT_PARAMS.n_trials
                );

                // create trial objects
                const experimental_trials = sampled_drawings.map((stimulus, index) => {
                    return createTrial(stimulus, index, false);
                });

                // create attention check trials
                const attention_trials = ATTENTION_CHECKS.map((check, index) => {
                    return createAttentionCheckTrial(check, index);
                });

                // space out attention checks
                const positions = [10, 35, 49];
                
                // Convert to a Set for O(1) lookup
                const positionsSet = new Set(positions);

                // merge trials and attention checks
                let trial_counter = 0;
                let attention_counter = 0;

                for (let i = 0; i < EXPERIMENT_PARAMS.n_trials; i++) {
                    // check if we should insert an attention check at this position
                    if (positionsSet.has(i) && attention_counter < attention_trials.length) {
                        all_trials.push(attention_trials[attention_counter]);
                        attention_counter++;
                    }
                    
                    // add the regular experimental trial
                    if (trial_counter < experimental_trials.length) {
                        all_trials.push(experimental_trials[trial_counter]);
                        trial_counter++;
                    }
                }
                
                return all_trials;
            }
            
            // create single trial
            function createTrial(stimulus, trial_number, is_attention_check) {
                // randomize position of the 3 images
                const images = [
                    stimulus.high_image,
                    stimulus.low_image,
                    stimulus.foil_image
                ];

                const shuffled_positions = jsPsych.randomization.shuffle([0,1,2]);
                const shuffled_images = shuffled_positions.map(pos => images[pos]);

                // correct answer position for delayed recall only
                let correct_position = null;
                if (stimulus.condition === 'delayed_recall') {
                    const target_idx = images.indexOf(stimulus.target_image);
                    correct_position = shuffled_positions.indexOf(target_idx);
                }

                const trial = {
                    type: jsPsychImageButtonResponse,
                    stimulus: stimulus.drawing,
                    stimulus_height: 350,
                    stimulus_width: null,
                    maintain_aspect_ratio: true,
                    choices: shuffled_images,
                    button_html: '<button class="jspsych-btn"><img src="%choice%" style="height:350px; width:auto;"></button>',
                    prompt: '<p>Which photograph does this drawing best represent?</p>',
                    data: {
                        task: 'main_trial',
                        trial_number: trial_number,
                        is_attention_check: is_attention_check,
                        drawing_filename: stimulus.drawing,
                        condition: stimulus.condition,
                        category: stimulus.category,
                        memorability: stimulus.memorability,
                        target_image: stimulus.target_image,
                        high_image: stimulus.high_image,
                        low_image: stimulus.low_image,
                        foil_image: stimulus.foil_image,
                        image_position_left: shuffled_images[0],
                        image_position_center: shuffled_images[1],
                        image_position_right: shuffled_images[2],
                        correct_position: correct_position,
                        participant_id: participant_id
                    },
                    on_finish: function(data) {
                        // determine which image was selected
                        data.selected_image = shuffled_images[data.response];

                        // for delayed recall, calculate accuracy
                        if (stimulus.condition === 'delayed_recall') {
                            data.correct = (data.response === correct_position);
                        }

                        // for category drawings, record which type was selected
                        if (stimulus.condition === 'category') {
                            if (data.selected_image === stimulus.high_image) {
                                data.selected_type = 'high';
                            }
                            else if (data.selected_image === stimulus.low_image) {
                                data.selected_type = 'low';
                            }
                            else {
                                data.selected_type = 'foil';
                            }
                        }
                        
                        trial_count++;
                        if (trial_count % SAVE_FREQUENCY === 0) {
                            saveDataIncremental();
                        }

                        // update progress bar
                        const progress = ((trial_number + 1) / EXPERIMENT_PARAMS.n_trials);
                        jsPsych.setProgressBar(progress);
                    }
                };

                return trial;

            }

            // create attention check trial
            function createAttentionCheckTrial(check, index) {
                const shuffled_images = jsPsych.randomization.shuffle([...check.images]);
                const correct_image = check.images[check.correct_position];
                const correct_response = shuffled_images.indexOf(correct_image);

                const trial = {
                    type: jsPsychImageButtonResponse,
                    stimulus: '',  // No image at top
                    stimulus_height: null,
                    choices: shuffled_images,
                    button_html: '<button class="jspsych-btn"><img src="%choice%" style="height:350px; width:auto;"></button>',
                    prompt: `<div style="padding: 20px 0; font-size: 24px; font-weight: bold;">${check.instruction}</div>`,
                    data: {
                        task: 'attention_check',
                        is_attention_check: true,
                        attention_check_number: index,
                        correct_response: correct_response,
                        participant_id: participant_id
                    },
                    on_finish: function(data) {
                        data.correct = (data.response === correct_response);
                        trial_count++;
                        if (trial_count % SAVE_FREQUENCY === 0) {
                            saveDataIncremental();
                        }
                    }
                };

                return trial;
                
            }

            function saveDataAsJsPsychTrial() {
                const save_trial = {
                    type: jsPsychPipe,
                    action: "save",
                    experiment_id: OSF_CONFIG.experiment_id,
                    filename: OSF_CONFIG.filename,
                    data_string: () => jsPsych.data.get().json()
                };
                
                jsPsych.addNodeToEndOfTimeline(save_trial);
            }

            function saveDataIncremental() {
                if (OSF_CONFIG.experiment_id === 'TODO') {
                    console.log('offline mode');
                    console.log('Trial count:', trial_count);
                    console.log('Recent data:', jsPsych.data.get().last(1).json());
                    return;
                }
                
                // separate trial for incremental saves
                const incremental_save = {
                    type: jsPsychPipe,
                    action: "save",
                    experiment_id: OSF_CONFIG.experiment_id,
                    filename: `${participant_id}_incremental_${Date.now()}.json`,
                    data_string: () => jsPsych.data.get().json()
                };
                
                jsPsych.addNodeToEndOfTimeline(incremental_save);
            }
            
            // display completion code
            function displayCompletionCode() {
                document.body.innerHTML = `
                    <div style="max-width: 800px; margin: 100px auto; text-align: center; font-family: Arial, sans-serif;">
                        <h2>Thank you for participating!</h2>
                        <p>You have completed the study.</p>
                        <p><strong>Your Prolific completion code is:</strong></p>
                        <h1 style="color: #2196F3; font-family: monospace; font-size: 48px;">${COMPLETION_CODE}</h1>
                        <p>Please copy this code and return to Prolific to paste it there.</p>
                    </div>
                `;
            }
        </script>
    </head>
<body></body>
</html>
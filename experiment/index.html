<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Drawing Match</title>
        
        <!-- jsPsych -->
        <script src="https://unpkg.com/jspsych@7.3.4"></script>
        <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
        <script src="https://unpkg.com/@jspsych/plugin-image-button-response@1.1.3"></script>
        <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>
        <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.3"></script>
        <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3"></script>
        <script src="https://unpkg.com/@jspsych/plugin-browser-check@1.0.3"></script>

        <!-- jsPsych CSS -->
        <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
        <!-- DataPipe for OSF -->
        <script src="https://pipe.jspsych.org/dist/datapipe.js"></script>
        
        <style>
            /* Custom styles for the drawing matching experiment */
            body {
                background-color: #f5f5f5;
                font-family: Arial, sans-serif;
            }

            #jspsych-content {
                max-width: 1200px;
                margin: auto;
            }

            .jspsych-btn {
                margin: 10px;
                padding: 0;
                border: 3px solid #ddd;
                background-color: white;
                cursor: pointer;
                transition: border-color 0.3s;
            }

            .jspsych-btn:hover {
                border-color: #2196F3;
            }

            .jspsych-btn img {
                display: block;
            }
        </style>

        <script>
            // config

            const OSF_CONFIG = {
                experimentID: 'TODO', // TODO
                filename: null, // dynamic
                dataType: 'json'
            };

            const EXPERIMENT_PARAMS = {
                n_trials: 60, // # trials per participant
                n_attention_checks: 3, // # attention check trials
                trial_timeout: 1800000, // 30 minutes (ms)
                min_rt_treshold: 500, // minimum RT for valid trials
                image_size: [380, 380] // for reference, the actual sizes are set directly in trial creation
            }

            const CATEGORIES = [
                'amusement_park',
                'badlands',
                'bathroom',
                'bedroom',
                'dining_room',
                'farm',
                'fountain',
                'garden',
                'house',
                'kitchen',
                'lighthouse',
                'living_room',
                'mountain',
                'playground',
                'pool',
                'street',
                'tower'
            ];

            const COMPLETION_CODE = 'TODO' // TODO
        
        // stimulus
        
        function generateDrawingStimuli() {
            const stimuli = [];
            // TODO: MANUALLY LOAD ALL THE IMAGES OR GET THEM AUTOMATICALLY?
            CATEGORIES.forEach(category => {
                // 2 delayed recall drawings per category
                ['high', 'low'].forEach(memorability => {
                    stimuli.push({
                        drawing: ``,
                        condition: 'delayed_recall',
                        category: category,
                        target_image: ``,
                        memorability: memorability,
                        high_image: `../data/stim/${category}_high.jpg`,
                        low_image: `../data/stim/${category}_high.jpg`,
                        foil_image: `../data/stim/${category}_high.jpg`
                    });
                });
            
                // 2 category drawings per category
                [1, 2].forEach(num => {
                    stimuli.push({
                        drawing: ``,
                        condition: 'category',
                        category: category,
                        target_image: null,  // no predetermined target for category drawings
                        memorability: null,
                        high_image: `../data/stim/${category}_high.jpg`,
                        low_image: `../data/stim/${category}_low.jpg`,
                        foil_image: `../data/stim/${category}_foil.jpg`
                    });
                });
            });

            return stimuli;

        }

        // attention check trials
        const ATTENTION_CHECKS = [
            {
                type: 'text_instruction',
                instruction: 'Please select the LEFTMOST image to show you are paying attention.',
                images: [], // TODO
                correct_position: 0 // 0=left
            },
            {
                type: 'text_instruction',
                instruction: 'Please select the CENTER image to show you are paying attention.',
                images: [], // TODO
                correct_position: 1

            },
            {
                type: 'text_instruction',
                instruction: 'Please select the RIGHTMOST image to show you are paying attention.',
                images: [], // TODO
                correct_position: 2

            },
        ];

        // experiment logic

        let jsPsych;
        let timeline = [];
        let participant_id;
        let start_time;

        window.onload = function() {
            // get prolific ID from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            participant_id = urlParams.get('PROLIFIC_ID') || 'debug_' + Date.now();

            // datapipe filename with participant ID
            OSF_CONFIG.filename = `${participant_id}.json`;

            jsPsych = initJsPsych({
                show_progress_bar: true,
                auto_update_progress_bar: false,
                message_progress_bar: 'Progress',
                on_finish: function() {
                    displayCompletionCode();
                },
                on_close: function() {
                    saveData();
                }
            });

            buildTimeline();
            jsPsych.run(timeline);
        }
        
        // build experiment timeline
        function buildTimeline() {
            // browser check
            const browser_check = {
                type: jsPsychBrowserCheck,
                inclusion_function: (data) => {
                    return !data.mobile;
                },
                exclusion_message: (data) => {
                    if (data.mobile) {
                        return '<p>This experiment must be completed on a desktop or laptop computer. Mobile devices are not supported.</p><p>Please return to this experiment on a desktop or laptop computer.</p>';
                    }
                }
            };
            timeline.push(browser_check);

            // welcome
            const welcome = {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: `
                    <div style="max-width: 800px; margin: auto;">
                        <h1>Welcome to the Drawing Match!</h1>
                        <p>Thank you for participating in this study.</p>
                        <p>In this experiment, you will see drawings of everyday scenes. Your task is to match each drawing to one of three photographs.</p>
                        <p>The experiment will take approximately 12 minutes to complete.</p>
                        <p><strong>Important:</strong></p>
                        <ul style="text-align: left;">
                            <li>Please complete this study in a quiet environment without distractions</li>
                            <li>Do not use the back button in your browser</li>
                            <li>Please stay focused on the task throughout</li>
                        </ul>
                        <p>Press the <strong>SPACE BAR</strong> to continue.</p>
                    </div>
                `,
                choices: [' ']
            };
            timeline.push(welcome);

            // instructions
            const instructions = {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: `
                    <div style="max-width: 800px; margin: auto;">
                        <h2>Instructions</h2>
                        <p>On each trial, you will see:</p>
                        <ul style="text-align: left;">
                            <li>One drawing at the top of the screen</li>
                            <li>Three photographs below the drawing</li>
                        </ul>
                        <p><strong>Your task:</strong> Click on the photograph that you think the drawing best represents.</p>
                        <p>The three photographs will always be from the same scene category (e.g., three different kitchens).</p>
                        <p>Even if the drawing is rough or incomplete, please try your best to make a match.</p>
                        <p>There is no time limit for each trial, but please respond as accurately as you can.</p>
                        <p>You will complete approximately 60 trials.</p>
                        <p>Press the <strong>SPACE BAR</strong> when you're ready to begin.</p>
                    </div>
                `,
                choices: [' '],
                on_finish: function() {
                    start_time = Date.now();
                }
            };
            timeline.push(instructions);

            // generate trials
            const trials = generateTrials();
            timeline.push(...trials);

            // ending survey
            const technical_difficulties = {
                type: jsPsychSurveyMultiChoice,
                questions: [
                    {
                        prompt: "Did you experience any technical difficulties during the task?",
                        name: 'technical_difficulties',
                        options: ['Yes', 'No'],
                        required: true
                    }
                ]
            };
            timeline.push(technical_difficulties);

            const technical_explanation = {
                type: jsPsychSurveyText,
                questions: [
                    {
                        prompt: "If you experienced technical difficulties, please describe them briefly:",
                        name: 'technical_explanation',
                        rows: 3,
                        required: false
                    }
                ]
            };
            timeline.push(technical_explanation);

            const comments = {
                type: jsPsychSurveyText,
                questions: [
                    {
                        prompt: "Do you have any comments about the study?",
                        name: 'comments',
                        rows: 3,
                        required: false
                    }
                ],
                on_finish: function() {
                    saveData();
                }
            };
            timeline.push(comments);

            // debrief
            const debrief = {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: function() {
                    return `
                        <div style="max-width: 800px; margin: auto;">
                            <h2>Thank you for participating!</h2>
                            <p>You have completed the study.</p>
                            <p><strong>Your Prolific completion code is:</strong></p>
                            <h1 style="color: #2196F3; font-family: monospace;">${COMPLETION_CODE}</h1>
                            <p>Please copy this code and return to Prolific to paste it there.</p>
                            <p>Press any key to finish.</p>
                        </div>
                    `;
                },
                choices: "ALL_KEYS"
            };
            timeline.push(debrief);
        }
        
        // generate experimental trials
        function generateTrials() {
            const all_trials = [];

            // get all drawings
            const all_drawings = generateDrawingStimuli();

            // randomly sample 60 drawings without replacement
            const sampled_drawings = jsPsych.randomization.sampleWithoutReplacement(
                all_drawings,
                EXPERIMENT_PARAMS.n_trials
            );

            // create trial objects
            const experimental_trials = sampled_drawings.map((stimulus, index) => {
                return createTrial(stimulus, index, false);
            });

            // create attention check trials
            const attention_trials = ATTENTION_CHECKS.map((check, index) => {
                return createAttentionCheckTrial(check, index);
            });

            // randomly insert attention checks
            const positions = jsPsych.randomization.sampleWithoutReplacement(
                Array.from({length: EXPERIMENT_PARAMS.n_trials}, (_, i) => i),
                EXPERIMENT_PARAMS.n_attention_checks
            ).sort((a, b) => a - b);

            // merge trials and attention checks
            let trial_counter = 0;
            let attention_counter = 0;

            for (let i = 0; i < EXPERIMENT_PARAMS.n_trials + EXPERIMENT_PARAMS.n_attention_checks; i++) {
                if (positions.includes(trial_counter) && attention_counter < attention_trials.length) {
                    all_trials.push(attention_trials[attention_counter]);
                    attention_counter++;
                }
                else if (trial_counter < experimental_trials.length) {
                    all_trials.push(experimental_trials[trial_counter]);
                    trial_counter++;
                }
            }
            return all_trials;
        }
        
        // create single trial
        function createTrial(stimulus, trial_number, is_attention_check) {
            // randomize position of the 3 images
            const images = [
                stimulus.high_image,
                stimulus.low_image,
                stimulus.foil_image
            ];

            const shuffled_positions = jsPsych.randomization.shuffle([0,1,2]);
            const shuffled_images = shuffled_positions.map(pos => images[pos]);

            // correct answer position for delayed recall only
            let correct_position = null;
            if (stimulus.condition === 'delayed_recall') {
                const target_idx = images.indexOf(stimulus.target_image);
                correct_position = shuffled_positions.indexOf(target_idx);
            }

            const trial = {
                type: jsPsychImageButtonResponse,
                stimulus: stimulus.drawing,
                stimulus_height: 350,
                stimulus_width: null,
                maintain_aspect_ratio: true,
                choices: shuffled_images,
                button_html: '<button class="jspsych-btn"><img src="%choice%" style="width:380px;"></button>',
                prompt: '<p>Which photograph does this drawing best represent?</p>',
                data: {
                    task: 'main_trial',
                    trial_number: trial_number,
                    is_attention_check: is_attention_check,
                    drawing_filename: stimulus.drawing,
                    condition: stimulus.condition,
                    category: stimulus.category,
                    memorability: stimulus.memorability,
                    target_image: stimulus.target_image,
                    high_image: stimulus.high_image,
                    low_image: stimulus.low_image,
                    foil_image: stimulus.foil_image,
                    image_position_left: shuffled_images[0],
                    image_position_center: shuffled_images[1],
                    image_position_right: shuffled_images[2],
                    correct_position: correct_position,
                    participant_id: participant_id
                },
                on_finish: function(data) {
                    // determine which image was selected
                    data.selected_image = shuffled_images[data.response];

                    // for delayed recall, calculate accuracy
                    if (stimulus.condition === 'delayed_recall') {
                        data.correct = (data.response === correct_position);
                    }

                    // for category drawings, record which type was selected
                    if (stimulus.condition === 'category') {
                        if (data.selected_image === stimulus.high_image) {
                            data.selected_type = 'high';
                        }
                        else if (data.selected_image === stimulus.low_image) {
                            data.selected_type = 'low';
                        }
                        else {
                            data.selected_type = 'foil';
                        }
                    }

                    // update progress bar
                    const progress = ((trial_number + 1) / EXPERIMENT_PARAMS.n_trials);
                    jsPsych.setProgressBar(progress);
                }
            };

            return trial;

        }

        
        
        </script>


</html>